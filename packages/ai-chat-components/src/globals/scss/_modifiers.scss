/* 
 *  Copyright IBM Corp. 2025
 *  
 *  This source code is licensed under the Apache-2.0 license found in the
 *  LICENSE file in the root directory of this source tree.
 */

@use "@carbon/layout";
@use "@carbon/styles/scss/theme";
@use "@carbon/styles/scss/utilities/convert" as *;
@use "./vars" as *;

// Note: This file is utilized at multiple places. please ensure changes here
// are compatible across all usages. since these modifiers are built with DRY principles,
// any changes here will affect all components that use these mixins.

/* ----- HELPERS ----- */
@mixin host-and-attr($selector) {
  :host(#{$selector}),
  #{$selector} {
    @content;
  }
}

@mixin radius($positions...) {
  @each $pos in $positions {
    border-#{$pos}-radius: calc(
      var(--#{$prefix}-rounded-modifier-radius) - rem(1px)
    );
  }
}

@mixin full-radius {
  border-radius: calc(var(--#{$prefix}-rounded-modifier-radius) - rem(1px));
}

/* ----- SHARED CHILD + BUTTON ROUNDING ----- */
@mixin round-child($selector, $positions...) {
  > #{$selector} {
    @include radius($positions...);

    &::part(button) {
      @include radius($positions...);
    }
  }
}

/* ----- ROUNDED MODIFIERS ----- */

/* ----- BASE (HOST-LEVEL ROUNDING) ----- */
@mixin rounded-base {
  @include host-and-attr('[data-rounded=""]') {
    @include full-radius;

    &::part(link),
    &::part(button) {
      @include full-radius;

      outline-offset: rem(-1px);
    }

    > :only-child {
      @include full-radius;
    }
  }
}

/* ----- HOST-ONLY POSITIONAL ROUNDING ----- */
$rounded-host-map: (
  top: (
    start-start,
    start-end,
  ),
  top-left: (
    start-start,
  ),
  top-right: (
    start-end,
  ),
  bottom: (
    end-start,
    end-end,
  ),
  bottom-left: (
    end-start,
  ),
  bottom-right: (
    end-end,
  ),
);

@mixin rounded-host-positions {
  @each $key, $positions in $rounded-host-map {
    @include host-and-attr('[data-rounded="#{$key}"]') {
      @include radius($positions...);
    }
  }
}

/* ----- NON-STACKED CHILDREN ROUNDING ----- */
$non-stacked-map: (
  top: (
    first: (
      start-start,
    ),
    last: (
      start-end,
    ),
  ),
  top-left: (
    first: (
      start-start,
    ),
  ),
  top-right: (
    last: (
      start-end,
    ),
  ),
  bottom: (
    first: (
      end-start,
    ),
    last: (
      end-end,
    ),
  ),
  bottom-left: (
    first: (
      end-start,
    ),
  ),
  bottom-right: (
    last: (
      end-end,
    ),
  ),
);

@mixin rounded-non-stacked {
  @each $key, $children in $non-stacked-map {
    @include host-and-attr('[data-rounded="#{$key}"]:not([data-stacked])') {
      @each $pos, $radius in $children {
        @include round-child(":#{$pos}-child", $radius...);
      }
    }
  }
}

/* ----- STACKED CHILDREN ROUNDING ----- */
$stacked-map: (
  top: (
    first: (
      start-start,
      start-end,
    ),
  ),
  top-right: (
    first: (
      start-end,
    ),
  ),
  top-left: (
    first: (
      start-start,
    ),
  ),
  bottom: (
    last: (
      end-start,
      end-end,
    ),
  ),
  bottom-right: (
    last: (
      end-end,
    ),
  ),
  bottom-left: (
    last: (
      end-start,
    ),
  ),
);

@mixin rounded-stacked {
  @each $key, $children in $stacked-map {
    @include host-and-attr('[data-rounded="#{$key}"][data-stacked]') {
      @each $pos, $radius in $children {
        @include round-child(":#{$pos}-child", $radius...);
      }
    }
  }
}

/* ----- PUBLIC ROUNDED MODIFIERS ENTRY POINT ----- */
@mixin rounded-modifiers {
  @include rounded-base;
  @include rounded-host-positions;
  @include rounded-non-stacked;
  @include rounded-stacked;
}

/* ----- LAYOUT MODIFIERS ----- */
@mixin stacked-modifiers {
  @include host-and-attr("[data-stacked]") {
    display: flex;
    flex-direction: column;
  }
}

@mixin flush-modifiers {
  @include host-and-attr('[data-flush=""]') {
    margin: calc(-1 * layout.$spacing-05);
  }

  @include host-and-attr('[data-flush="top"]') {
    margin-block-start: calc(-1 * layout.$spacing-05);
    margin-inline: calc(-1 * layout.$spacing-05);
  }

  @include host-and-attr('[data-flush="bottom"]') {
    margin-block-end: calc(-1 * layout.$spacing-05);
    margin-inline: calc(-1 * layout.$spacing-05);
  }
}
